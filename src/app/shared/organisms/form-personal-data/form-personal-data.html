<div class="purchase-order__content">
  <div class="container">
    <div class="form-layout">
      <!-- Formulario - Columna izquierda -->
      <div class="customer-form-section">
        <div class="form-header">
          <h2 class="form-title">Informaci√≥n de Contacto y Entrega</h2>
          <div class="delivery-badge">
            <span class="delivery-badge__icon">{{ deliveryBadgeText() }}</span>
            <span class="delivery-badge__text">{{ deliveryOptionText() }}</span>
          </div>
        </div>

        <form [formGroup]="orderForm" (ngSubmit)="onNextStep()" class="purchase-form" novalidate>
          <!-- Informaci√≥n Personal -->
          <div class="form-section">
            <div class="form-section__header">
              <h3 class="form-section__title">
                <span class="form-section__icon">üë§</span>
                Informaci√≥n Personal
              </h3>
              <p class="form-section__description">Datos necesarios para contactarte</p>
            </div>

            <div class="form-grid">
              <!-- Nombre -->
              <div class="form-group">
                <label for="firstName" class="form-label">
                  Nombre <span class="required">*</span>
                </label>
                <div class="form-input-wrapper">
                  <input
                    type="text"
                    id="firstName"
                    formControlName="firstName"
                    class="form-control"
                    [class.form-control--error]="isFieldInvalid('firstName')"
                    placeholder="Ingresa tu nombre"
                    autocomplete="given-name">
                  @if (isFieldInvalid('firstName')) {
                    <span class="form-error">
                      <span class="form-error__icon">‚ö†Ô∏è</span>
                      {{ getFieldError('firstName') }}
                    </span>
                  }
                </div>
              </div>

              <!-- Apellido -->
              <div class="form-group">
                <label for="lastName" class="form-label">
                  Apellido <span class="required">*</span>
                </label>
                <div class="form-input-wrapper">
                  <input
                    type="text"
                    id="lastName"
                    formControlName="lastName"
                    class="form-control"
                    [class.form-control--error]="isFieldInvalid('lastName')"
                    placeholder="Ingresa tu apellido"
                    autocomplete="family-name">
                  @if (isFieldInvalid('lastName')) {
                    <span class="form-error">
                      <span class="form-error__icon">‚ö†Ô∏è</span>
                      {{ getFieldError('lastName') }}
                    </span>
                  }
                </div>
              </div>

              <!-- Email -->
              <div class="form-group">
                <label for="email" class="form-label">
                  Correo Electr√≥nico <span class="required">*</span>
                </label>
                <div class="form-input-wrapper">
                  <input
                    type="email"
                    id="email"
                    formControlName="email"
                    class="form-control"
                    [class.form-control--error]="isFieldInvalid('email')"
                    placeholder="ejemplo@correo.com"
                    autocomplete="email">
                  @if (isFieldInvalid('email')) {
                    <span class="form-error">
                      <span class="form-error__icon">‚ö†Ô∏è</span>
                      {{ getFieldError('email') }}
                    </span>
                  }
                </div>
              </div>

              <!-- Tel√©fono -->
              <div class="form-group">
                <label for="phone" class="form-label">
                  Tel√©fono <span class="required">*</span>
                </label>
                <div class="form-input-wrapper">
                  <input
                    type="tel"
                    id="phone"
                    formControlName="phone"
                    class="form-control"
                    [class.form-control--error]="isFieldInvalid('phone')"
                    placeholder="+54 9 11 1234-5678"
                    autocomplete="tel">
                  @if (isFieldInvalid('phone')) {
                    <span class="form-error">
                      <span class="form-error__icon">‚ö†Ô∏è</span>
                      {{ getFieldError('phone') }}
                    </span>
                  }
                </div>
              </div>
            </div>
          </div>

          <!-- Direcci√≥n de Entrega - SOLO para delivery -->
          @if (isDelivery()) {
            <div class="form-section">
              <!-- Header -->
              <div class="form-section__header">
                <h3 class="form-section__title">
                  <span class="form-section__icon">üìç</span>
                  Direcci√≥n de Entrega
                </h3>
                <p class="form-section__description">Selecciona una direcci√≥n guardada o ingresa una nueva</p>
              </div>

              <!-- Loading state -->
              @if (isLoadingAddresses()) {
                <div class="address-loading">
                  <div class="loading-spinner"></div>
                  <p class="loading-text">Cargando direcciones...</p>
                </div>
              }

              <!-- Error state -->
              @if (addressesError()) {
                <div class="address-error">
                  <span class="error-icon">‚ö†Ô∏è</span>
                  <p class="error-text">{{ addressesError() }}</p>
                </div>
              }

              <!-- Selector de direcciones guardadas -->
              @if (!isLoadingAddresses()) {
                <div class="form-group form-group--full">
                  <label for="savedAddress" class="form-label">
                    <span class="form-label__icon">üìã</span>
                    Direcciones guardadas
                    <span class="form-label__count">({{ savedAddresses().length }})</span>
                  </label>
                  <div class="form-input-wrapper">
                    <select
                      id="savedAddress"
                      class="form-control form-control--select"
                      [value]="selectedAddressId() || ''"
                      (change)="onAddressChange($event)">
                      <option value="">-- Ingresar direcci√≥n manualmente --</option>
                      @for (address of savedAddresses(); track address.id) {
                        <option [value]="address.id">
                          {{ formatAddressForSelect(address) }}
                          @if (address.isDefault) {
                            (Predeterminada)
                          }
                        </option>
                      }
                    </select>
                    <span class="form-helper">
                      @if (selectedAddressId()) {
                        ‚úÖ Direcci√≥n seleccionada
                      } @else {
                        üí° Selecciona una direcci√≥n o completa los campos abajo
                      }
                    </span>
                  </div>
                </div>

                <!-- Separador visual -->
                <div class="form-divider">
                  <span class="form-divider__text">o completa manualmente</span>
                </div>
              }

              <!-- Campos de direcci√≥n manual -->
              <div class="form-grid">
                <!-- Provincia -->
                <div class="form-group">
                  <label for="province" class="form-label">
                    Provincia <span class="required">*</span>
                  </label>
                  <div class="form-input-wrapper">
                    <input
                      id="province"
                      type="text"
                      formControlName="province"
                      class="form-control"
                      [class.form-control--error]="isFieldInvalid('province')"
                      placeholder="Tu provincia"
                      autocomplete="address-level1">
                    @if (isFieldInvalid('province')) {
                      <span class="form-error">
                        <span class="form-error__icon">‚ö†Ô∏è</span>
                        {{ getFieldError('province') }}
                      </span>
                    }
                  </div>
                </div>

                <!-- Ciudad -->
                <div class="form-group">
                  <label for="city" class="form-label">
                    Ciudad <span class="required">*</span>
                  </label>
                  <div class="form-input-wrapper">
                    <input
                      id="city"
                      type="text"
                      formControlName="city"
                      class="form-control"
                      [class.form-control--error]="isFieldInvalid('city')"
                      placeholder="Tu ciudad"
                      autocomplete="address-level2">
                    @if (isFieldInvalid('city')) {
                      <span class="form-error">
                        <span class="form-error__icon">‚ö†Ô∏è</span>
                        {{ getFieldError('city') }}
                      </span>
                    }
                  </div>
                </div>

                <!-- Direcci√≥n completa -->
                <div class="form-group form-group--full">
                  <label for="address" class="form-label">
                    Direcci√≥n completa <span class="required">*</span>
                  </label>
                  <div class="form-input-wrapper">
                    <input
                      id="address"
                      type="text"
                      formControlName="address"
                      class="form-control"
                      [class.form-control--error]="isFieldInvalid('address')"
                      placeholder="Calle, n√∫mero, piso, depto..."
                      autocomplete="street-address">
                    @if (isFieldInvalid('address')) {
                      <span class="form-error">
                        <span class="form-error__icon">‚ö†Ô∏è</span>
                        {{ getFieldError('address') }}
                      </span>
                    }
                  </div>
                </div>

                <!-- C√≥digo Postal -->
                <div class="form-group">
                  <label for="postalCode" class="form-label">
                    C√≥digo Postal <span class="required">*</span>
                  </label>
                  <div class="form-input-wrapper">
                    <input
                      id="postalCode"
                      type="text"
                      formControlName="postalCode"
                      class="form-control"
                      [class.form-control--error]="isFieldInvalid('postalCode')"
                      placeholder="C√≥digo postal"
                      autocomplete="postal-code">
                    @if (isFieldInvalid('postalCode')) {
                      <span class="form-error">
                        <span class="form-error__icon">‚ö†Ô∏è</span>
                        {{ getFieldError('postalCode') }}
                      </span>
                    }
                  </div>
                </div>
              </div>

              <!-- ‚úÖ CHECKBOX PARA GUARDAR -->
              @if (showSaveAddressOption() && isManualAddressComplete()) {
                <div class="save-address-option">
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      class="checkbox-input"
                      [checked]="saveNewAddress()"
                      (change)="onSaveAddressChange($event)">
                    <span class="checkbox-custom"></span>
                    <span class="checkbox-text">
                      <strong>üíæ Guardar esta direcci√≥n</strong>
                      <span class="checkbox-description">
                        Para usarla en futuros pedidos
                      </span>
                    </span>
                  </label>
                </div>
              }
            </div>
          }

          <!-- Informaci√≥n Adicional -->
          <div class="form-section">
            <div class="form-section__header">
              <h3 class="form-section__title">
                <span class="form-section__icon">üìù</span>
                Informaci√≥n Adicional
              </h3>
              <p class="form-section__description">Notas opcionales para tu pedido</p>
            </div>

            <div class="form-group form-group--full">
              <label for="deliveryInstructions" class="form-label">
                Notas para el pedido (opcional)
              </label>
              <div class="form-input-wrapper">
                <textarea
                  id="deliveryInstructions"
                  formControlName="deliveryInstructions"
                  class="form-control form-control--textarea"
                  placeholder="Indicaciones especiales, horarios de entrega, etc..."
                  rows="4"></textarea>
                <span class="form-helper">
                  {{ isDelivery()
                    ? 'Incluye referencias para encontrar tu domicilio m√°s f√°cilmente'
                    : 'Ind√≠canos tu horario preferido para el retiro' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Botones de navegaci√≥n -->
          <div class="form-actions">
            <button type="button" class="btn btn--secondary" (click)="onEditCart()">
              <span class="btn__icon">‚Üê</span>
              <span class="btn__text">Editar Carrito</span>
            </button>

            <button type="submit" class="btn btn--primary" [disabled]="!formValid()">
              <span class="btn__text">Continuar</span>
              <span class="btn__icon">‚Üí</span>
            </button>
          </div>
        </form>
      </div>

      <!-- Resumen del Pedido - Columna derecha -->
      <aside class="order-sidebar">
        <div class="order-summary-card">
          <h3 class="summary-title">Resumen del Pedido</h3>

          <!-- Productos -->
          @if (hasCartItems()) {
            <div class="summary-section">
              <h4 class="summary-subtitle">Productos ({{ cartItemsCount() }})</h4>
              <div class="summary-items">
                @for (item of cartItems(); track item.id) {
                  <div class="summary-item">
                    <div class="item-details">
                      <span class="item-name">{{ item.name }}</span>
                      @if (item.brand) {
                        <span class="item-brand">{{ item.brand }}</span>
                      }
                    </div>
                    <div class="item-quantity">x{{ item.quantity }}</div>
                    <div class="item-price">${{ (item.price * item.quantity).toFixed(2) }}</div>
                  </div>
                }
              </div>
            </div>
          } @else {
            <div class="summary-section summary-section--empty">
              <p class="summary-empty">No hay productos en el carrito</p>
            </div>
          }

          <!-- Totales -->
          <div class="summary-totals">
            <div class="total-row">
              <span>Subtotal:</span>
              <span>${{ subtotal().toFixed(2) }}</span>
            </div>
            <div class="total-row">
              <span>Env√≠o:</span>
              <span>{{ shippingText() }}</span>
            </div>
            <div class="total-row">
              <span>IVA (21%):</span>
              <span>${{ ivaAmount().toFixed(2) }}</span>
            </div>
            <div class="total-row total-row--final">
              <span>Total:</span>
              <span>${{ totalWithIva().toFixed(2) }}</span>
            </div>
          </div>

          <!-- Informaci√≥n de Entrega -->
          <div class="delivery-info">
            <div class="delivery-info__item">
              <span class="delivery-info__label">Modalidad:</span>
              <span class="delivery-info__value">{{ deliveryOptionText() }}</span>
            </div>
            <div class="delivery-info__item">
              <span class="delivery-info__label">{{ deliveryTimeLabel() }}</span>
              <span class="delivery-info__value">{{ deliveryTimeText() }}</span>
            </div>
          </div>

          <!-- Estado de Validaci√≥n -->
          <div class="validation-status">
            @if (formValid()) {
              <div class="validation-status__success">
                <span class="validation-status__icon">‚úÖ</span>
                <span class="validation-status__text">{{ validationMessage() }}</span>
              </div>
            } @else {
              <div class="validation-status__pending">
                <span class="validation-status__icon">‚ö†Ô∏è</span>
                <span class="validation-status__text">{{ validationMessage() }}</span>
              </div>
            }
          </div>
        </div>
      </aside>
    </div>
  </div>
</div>
