<section class="recovery">
  <div class="recovery__card">
    <!-- Header -->
    <header class="recovery__header">
      <h1 class="recovery__title">Recuperar contrase√±a</h1>
      <p class="recovery__subtitle">Sigue los pasos para restaurar acceso a tu cuenta</p>
    </header>

    <!-- Progress Indicator -->
    <div class="recovery__progress" role="progressbar" [attr.aria-valuenow]="getCurrentStepNumber()" aria-valuemin="1" aria-valuemax="3">
      <div 
        class="recovery__progress-item"
        [class.recovery__progress-item--active]="step() === 'email'"
        [class.recovery__progress-item--completed]="step() === 'code' || step() === 'password'">
        <span class="recovery__progress-number">1</span>
        <span class="recovery__progress-label">Email</span>
      </div>
      <div class="recovery__progress-line" [class.recovery__progress-line--completed]="step() === 'code' || step() === 'password'"></div>
      <div 
        class="recovery__progress-item"
        [class.recovery__progress-item--active]="step() === 'code'"
        [class.recovery__progress-item--completed]="step() === 'password'">
        <span class="recovery__progress-number">2</span>
        <span class="recovery__progress-label">C√≥digo</span>
      </div>
      <div class="recovery__progress-line" [class.recovery__progress-line--completed]="step() === 'password'"></div>
      <div 
        class="recovery__progress-item"
        [class.recovery__progress-item--active]="step() === 'password'">
        <span class="recovery__progress-number">3</span>
        <span class="recovery__progress-label">Nueva contrase√±a</span>
      </div>
    </div>

    <!-- Success Message -->
    @if (successMessage()) {
      <div class="recovery__alert recovery__alert--success" role="alert">
        <span class="recovery__alert-icon" aria-hidden="true">‚úì</span>
        <p class="recovery__alert-text">{{ successMessage() }}</p>
      </div>
    }

    <!-- Error Message -->
    @if (error()) {
      <div class="recovery__alert recovery__alert--error" role="alert">
        <span class="recovery__alert-icon" aria-hidden="true">‚ö†Ô∏è</span>
        <p class="recovery__alert-text">{{ error() }}</p>
      </div>
    }

    <!-- Form -->
    <form [formGroup]="form" class="recovery__form">
      
      <!-- STEP 1: Email Input -->
      @if (step() === 'email') {
        <div class="recovery__step" [@fadeIn]>
          <div class="recovery__step-header">
            <h2 class="recovery__step-title">Verifica tu correo</h2>
            <p class="recovery__step-description">
              Ingresa tu correo electr√≥nico y te enviaremos un c√≥digo de recuperaci√≥n
            </p>
          </div>

          <div class="recovery__form-group">
            <label class="recovery__label" for="email">
              Correo electr√≥nico
              <abbr class="recovery__required" title="Campo requerido">*</abbr>
            </label>
            <input
              id="email"
              type="email"
              formControlName="email"
              class="recovery__input"
              [class.recovery__input--error]="form.get('email')?.touched && form.get('email')?.invalid"
              placeholder="ejemplo@correo.com"
              autocomplete="email"
              [attr.aria-invalid]="form.get('email')?.touched && form.get('email')?.invalid"
              [attr.aria-describedby]="form.get('email')?.touched && form.get('email')?.invalid ? 'email-error' : null"
            />
            @if (form.get('email')?.touched && form.get('email')?.invalid) {
              <p id="email-error" class="recovery__error" role="alert">
                @if (form.get('email')?.hasError('required')) {
                  El correo es requerido.
                } @else if (form.get('email')?.hasError('email')) {
                  Ingresa un correo v√°lido.
                }
              </p>
            }
          </div>

          <div class="recovery__actions">
            <button
              type="button"
              class="recovery__btn recovery__btn--primary"
              (click)="submitEmail()"
              [disabled]="!canSubmitEmail()">
              @if (loading()) {
                <span class="recovery__spinner" aria-hidden="true"></span>
                <span>Enviando c√≥digo...</span>
              } @else {
                <span>Enviar c√≥digo</span>
              }
            </button>
          </div>
        </div>
      }

      <!-- STEP 2: Code Verification -->
      @if (step() === 'code') {
        <div class="recovery__step" [@fadeIn]>
          <div class="recovery__step-header">
            <h2 class="recovery__step-title">Ingresa el c√≥digo</h2>
            <p class="recovery__step-description">
              Hemos enviado un c√≥digo de 6 d√≠gitos a <strong>{{ emailSent() }}</strong>
            </p>
          </div>

          <div class="recovery__form-group">
            <label class="recovery__label" for="code">
              C√≥digo de recuperaci√≥n
              <abbr class="recovery__required" title="Campo requerido">*</abbr>
            </label>
            <input
              id="code"
              type="text"
              formControlName="code"
              class="recovery__input recovery__input--code"
              [class.recovery__input--error]="form.get('code')?.touched && form.get('code')?.invalid"
              placeholder="000000"
              maxlength="6"
              autocomplete="off"
              inputmode="numeric"
              (input)="onCodeInput($event)"
              [attr.aria-invalid]="form.get('code')?.touched && form.get('code')?.invalid"
              [attr.aria-describedby]="form.get('code')?.touched && form.get('code')?.invalid ? 'code-error' : 'code-help'"
            />
            <p id="code-help" class="recovery__helper-text">C√≥digo de 6 d√≠gitos num√©ricos</p>
            @if (form.get('code')?.touched && form.get('code')?.invalid) {
              <p id="code-error" class="recovery__error" role="alert">
                @if (form.get('code')?.hasError('required')) {
                  El c√≥digo es requerido.
                } @else if (form.get('code')?.hasError('minlength')) {
                  El c√≥digo debe tener 6 d√≠gitos.
                }
              </p>
            }
          </div>

          <div class="recovery__actions">
            <button
              type="button"
              class="recovery__btn recovery__btn--primary"
              (click)="submitCode()"
              [disabled]="!canSubmitCode()">
              @if (loading()) {
                <span class="recovery__spinner" aria-hidden="true"></span>
                <span>Verificando...</span>
              } @else {
                <span>Verificar c√≥digo</span>
              }
            </button>

            <button
              type="button"
              class="recovery__btn recovery__btn--text"
              (click)="resendCode()"
              [disabled]="loading()">
              Reenviar c√≥digo
            </button>

            <button
              type="button"
              class="recovery__btn recovery__btn--text"
              (click)="goToPreviousStep()"
              [disabled]="loading()">
              Cambiar correo
            </button>
          </div>
        </div>
      }

      <!-- STEP 3: New Password -->
      @if (step() === 'password') {
        <div class="recovery__step" [@fadeIn]>
          <div class="recovery__step-header">
            <h2 class="recovery__step-title">Nueva contrase√±a</h2>
            <p class="recovery__step-description">
              Crea una contrase√±a fuerte para proteger tu cuenta
            </p>
          </div>

          <!-- New Password Field -->
          <div class="recovery__form-group">
            <label class="recovery__label" for="newPassword">
              Nueva contrase√±a
              <abbr class="recovery__required" title="Campo requerido">*</abbr>
            </label>
            <div class="recovery__password-wrapper">
              <input
                id="newPassword"
                [type]="newPasswordVisible() ? 'text' : 'password'"
                formControlName="newPassword"
                class="recovery__input"
                [class.recovery__input--error]="form.get('newPassword')?.touched && form.get('newPassword')?.invalid"
                placeholder="M√≠nimo 8 caracteres"
                autocomplete="new-password"
                [attr.aria-invalid]="form.get('newPassword')?.touched && form.get('newPassword')?.invalid"
                [attr.aria-describedby]="form.get('newPassword')?.touched && form.get('newPassword')?.invalid ? 'new-password-error' : 'new-password-help'"
              />
              <button
                type="button"
                class="recovery__toggle"
                (click)="toggleNewPasswordVisibility()"
                [attr.aria-label]="newPasswordVisible() ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a'"
                [attr.aria-pressed]="newPasswordVisible()">
                <span aria-hidden="true">{{ newPasswordVisible() ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è' }}</span>
              </button>
            </div>
            <p id="new-password-help" class="recovery__helper-text">Debe contener al menos 8 caracteres</p>
            @if (form.get('newPassword')?.touched && form.get('newPassword')?.invalid) {
              <p id="new-password-error" class="recovery__error" role="alert">
                @if (form.get('newPassword')?.hasError('required')) {
                  La contrase√±a es requerida.
                } @else if (form.get('newPassword')?.hasError('minlength')) {
                  La contrase√±a debe tener al menos 8 caracteres.
                }
              </p>
            }
          </div>

          <!-- Confirm Password Field -->
          <div class="recovery__form-group">
            <label class="recovery__label" for="confirmPassword">
              Confirmar contrase√±a
              <abbr class="recovery__required" title="Campo requerido">*</abbr>
            </label>
            <div class="recovery__password-wrapper">
              <input
                id="confirmPassword"
                [type]="confirmPasswordVisible() ? 'text' : 'password'"
                formControlName="confirmPassword"
                class="recovery__input"
                [class.recovery__input--error]="(form.get('confirmPassword')?.touched && form.get('confirmPassword')?.invalid) || (form.get('confirmPassword')?.touched && !passwordsMatch())"
                placeholder="Repite la contrase√±a"
                autocomplete="new-password"
                [attr.aria-invalid]="(form.get('confirmPassword')?.touched && form.get('confirmPassword')?.invalid) || !passwordsMatch()"
                [attr.aria-describedby]="(form.get('confirmPassword')?.touched && form.get('confirmPassword')?.invalid) || !passwordsMatch() ? 'confirm-password-error' : null"
              />
              <button
                type="button"
                class="recovery__toggle"
                (click)="toggleConfirmPasswordVisibility()"
                [attr.aria-label]="confirmPasswordVisible() ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a'"
                [attr.aria-pressed]="confirmPasswordVisible()">
                <span aria-hidden="true">{{ confirmPasswordVisible() ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è' }}</span>
              </button>
            </div>
            @if (form.get('confirmPassword')?.touched) {
              @if (form.get('confirmPassword')?.invalid) {
                <p id="confirm-password-error" class="recovery__error" role="alert">
                  @if (form.get('confirmPassword')?.hasError('required')) {
                    Confirma la contrase√±a.
                  } @else if (form.get('confirmPassword')?.hasError('minlength')) {
                    La contrase√±a debe tener al menos 8 caracteres.
                  }
                </p>
              } @else if (!passwordsMatch()) {
                <p id="confirm-password-error" class="recovery__error" role="alert">
                  Las contrase√±as no coinciden.
                </p>
              }
            }
          </div>

          <div class="recovery__actions">
            <button
              type="button"
              class="recovery__btn recovery__btn--primary"
              (click)="submitNewPassword()"
              [disabled]="!canSubmitPassword()">
              @if (loading()) {
                <span class="recovery__spinner" aria-hidden="true"></span>
                <span>Actualizando...</span>
              } @else {
                <span>Actualizar contrase√±a</span>
              }
            </button>

            <button
              type="button"
              class="recovery__btn recovery__btn--text"
              (click)="goToPreviousStep()"
              [disabled]="loading()">
              Volver al c√≥digo
            </button>
          </div>
        </div>
      }
    </form>

    <!-- Footer -->
    <footer class="recovery__footer">
      <button
        type="button"
        class="recovery__link"
        (click)="onBackToLogin()"
        [disabled]="loading()">
        ‚Üê Volver al inicio de sesi√≥n
      </button>
    </footer>
  </div>
</section>
