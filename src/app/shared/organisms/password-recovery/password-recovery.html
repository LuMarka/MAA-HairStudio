<section class="recovery">
  <div class="recovery__card">
    <div class="recovery__header">
      <h1 class="recovery__title">Recuperar contrase√±a</h1>
      <p class="recovery__subtitle">Sigue los pasos para restaurar acceso a tu cuenta</p>
    </div>

    <form [formGroup]="form" class="recovery__form">
      <!-- Step 1: Email -->
      @if (step() === 'email') {
        <div class="recovery__step">
          <div class="recovery__step-header">
            <div class="recovery__step-number">1</div>
            <h2 class="recovery__step-title">Verifica tu correo</h2>
          </div>

          <p class="recovery__step-description">
            Ingresa tu correo electr√≥nico y te enviaremos un c√≥digo de recuperaci√≥n
          </p>

          <div class="recovery__form-group">
            <label class="recovery__label" for="email">Correo electr√≥nico</label>
            <input
              id="email"
              type="email"
              formControlName="email"
              class="recovery__input"
              [class.recovery__input--error]="form.get('email')?.touched && form.get('email')?.invalid"
              placeholder="ejemplo@correo.com"
              autocomplete="email"
            />
            @if (form.get('email')?.touched && form.get('email')?.invalid) {
              <p class="recovery__error">
                @if (form.get('email')?.errors?.['required']) {
                  El correo es requerido.
                } @else if (form.get('email')?.errors?.['email']) {
                  Ingresa un correo v√°lido.
                }
              </p>
            }
          </div>

          @if (error()) {
            <div class="recovery__alert recovery__alert--error">
              <span class="recovery__alert-icon">‚ö†Ô∏è</span>
              {{ error() }}
            </div>
          }

          <button
            type="button"
            class="recovery__btn recovery__btn--primary"
            (click)="submitEmail()"
            [disabled]="loading() || form.get('email')?.invalid"
          >
            @if (loading()) {
              <span class="recovery__spinner"></span>
              Enviando c√≥digo...
            } @else {
              Enviar c√≥digo
            }
          </button>
        </div>
      }

      <!-- Step 2: Code -->
      @else if (step() === 'code') {
        <div class="recovery__step">
          <div class="recovery__step-header">
            <div class="recovery__step-number">2</div>
            <h2 class="recovery__step-title">Ingresa el c√≥digo</h2>
          </div>

          <p class="recovery__step-description">
            Busca el correo de MAA Hair Studio y copia el c√≥digo de 6 d√≠gitos
          </p>

          <div class="recovery__form-group">
            <label class="recovery__label" for="code">C√≥digo de recuperaci√≥n</label>
            <input
              id="code"
              type="text"
              formControlName="code"
              class="recovery__input recovery__input--code"
              [class.recovery__input--error]="form.get('code')?.touched && form.get('code')?.invalid"
              placeholder="000000"
              maxlength="6"
              autocomplete="off"
              inputmode="numeric"
            />
            <p class="recovery__helper-text">C√≥digo de 6 d√≠gitos</p>
            @if (form.get('code')?.touched && form.get('code')?.invalid) {
              <p class="recovery__error">
                @if (form.get('code')?.errors?.['required']) {
                  El c√≥digo es requerido.
                } @else if (form.get('code')?.errors?.['minlength']) {
                  El c√≥digo debe tener 6 d√≠gitos.
                }
              </p>
            }
          </div>

          @if (error()) {
            <div class="recovery__alert recovery__alert--error">
              <span class="recovery__alert-icon">‚ö†Ô∏è</span>
              {{ error() }}
            </div>
          }

          <div class="recovery__button-group">
            <button
              type="button"
              class="recovery__btn recovery__btn--primary"
              (click)="submitCode()"
              [disabled]="loading() || form.get('code')?.invalid"
            >
              @if (loading()) {
                <span class="recovery__spinner"></span>
                Verificando...
              } @else {
                Verificar c√≥digo
              }
            </button>

            <button
              type="button"
              class="recovery__btn recovery__btn--secondary"
              (click)="onBackToLogin()"
              [disabled]="loading()"
            >
              Cancelar
            </button>
          </div>
        </div>
      }

      <!-- Step 3: New Password -->
      @else if (step() === 'password') {
        <div class="recovery__step">
          <div class="recovery__step-header">
            <div class="recovery__step-number">3</div>
            <h2 class="recovery__step-title">Nueva contrase√±a</h2>
          </div>

          <p class="recovery__step-description">
            Crea una contrase√±a fuerte para proteger tu cuenta
          </p>

          <!-- New Password -->
          <div class="recovery__form-group">
            <label class="recovery__label" for="newPassword">Nueva contrase√±a</label>
            <div class="recovery__password-wrapper">
              <input
                id="newPassword"
                [type]="newPasswordVisible() ? 'text' : 'password'"
                formControlName="newPassword"
                class="recovery__input"
                [class.recovery__input--error]="form.get('newPassword')?.touched && form.get('newPassword')?.invalid"
                placeholder="Contrase√±a"
                autocomplete="new-password"
              />
              <button
                type="button"
                class="recovery__toggle"
                (click)="toggleNewPasswordVisibility()"
                tabindex="-1"
                [attr.aria-label]="newPasswordVisible() ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a'"
              >
                {{ newPasswordVisible() ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è' }}
              </button>
            </div>
            @if (form.get('newPassword')?.touched && form.get('newPassword')?.invalid) {
              <p class="recovery__error">
                @if (form.get('newPassword')?.errors?.['required']) {
                  La contrase√±a es requerida.
                } @else if (form.get('newPassword')?.errors?.['minlength']) {
                  M√≠nimo 6 caracteres.
                }
              </p>
            }
          </div>

          <!-- Confirm Password -->
          <div class="recovery__form-group">
            <label class="recovery__label" for="confirmPassword">Confirmar contrase√±a</label>
            <div class="recovery__password-wrapper">
              <input
                id="confirmPassword"
                [type]="confirmPasswordVisible() ? 'text' : 'password'"
                formControlName="confirmPassword"
                class="recovery__input"
                [class.recovery__input--error]="form.get('confirmPassword')?.touched && form.get('confirmPassword')?.invalid"
                placeholder="Confirmar contrase√±a"
                autocomplete="new-password"
              />
              <button
                type="button"
                class="recovery__toggle"
                (click)="toggleConfirmPasswordVisibility()"
                tabindex="-1"
                [attr.aria-label]="confirmPasswordVisible() ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a'"
              >
                {{ confirmPasswordVisible() ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è' }}
              </button>
            </div>
            @if (form.get('confirmPassword')?.touched && form.get('confirmPassword')?.invalid) {
              <p class="recovery__error">
                @if (form.get('confirmPassword')?.errors?.['required']) {
                  Confirma la contrase√±a.
                } @else if (form.get('confirmPassword')?.errors?.['minlength']) {
                  M√≠nimo 6 caracteres.
                }
              </p>
            }
          </div>

          @if (error()) {
            <div class="recovery__alert recovery__alert--error">
              <span class="recovery__alert-icon">‚ö†Ô∏è</span>
              {{ error() }}
            </div>
          }

          <button
            type="button"
            class="recovery__btn recovery__btn--primary"
            (click)="submitNewPassword()"
            [disabled]="loading() || form.get('newPassword')?.invalid || form.get('confirmPassword')?.invalid"
          >
            @if (loading()) {
              <span class="recovery__spinner"></span>
              Actualizando...
            } @else {
              Actualizar contrase√±a
            }
          </button>
        </div>
      }
    </form>

    <!-- Back to login link -->
    <div class="recovery__footer">
      <p class="recovery__footer-text">
        <a (click)="onBackToLogin()" class="recovery__link">‚Üê Volver al inicio de sesi√≥n</a>
      </p>
    </div>
  </div>
</section>
