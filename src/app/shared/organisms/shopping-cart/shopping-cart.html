<!-- Carrito de Compras -->
<div class="cart">
  <div class="cart__header">
    <h1 class="cart__title">Carrito de Compras</h1>
    @if (hasItems()) {
      <span class="cart__count">{{ totalItems() }} producto(s)</span>
    }
  </div>

  <!-- Empty State -->
  @if (isEmpty()) {
    <div class="cart--empty">
      <div class="cart__empty">
        <div class="cart__empty-icon">üõí</div>
        <h2 class="cart__empty-title">Tu carrito est√° vac√≠o</h2>
        <p class="cart__empty-text">
          Explora nuestros productos profesionales para el cabello y encuentra lo que necesitas.
        </p>
        <button
          type="button"
          class="cart__btn cart__btn--primary"
          (click)="continueShopping()">
          Continuar comprando
        </button>
      </div>
    </div>
  }

  <!-- Cart Content -->
  @if (hasItems()) {
    <div class="cart__content">
      <!-- Lista de productos -->
      <div class="cart__items">
        @for (item of items(); track item.id) {
          <article
            class="cart-item"
            [class.cart-item--unavailable]="!isAvailable(item)">

            <div class="cart-item__image-container">
              <img
                [src]="item.product.image"
                [alt]="item.product.name"
                loading="lazy"
                class="cart-item__image">

              @if (!isAvailable(item)) {
                <div class="cart-item__unavailable-badge">
                  No disponible
                </div>
              }
            </div>

            <div class="cart-item__info">
              <div class="cart-item__details cart-item__details--clickable" (click)="goToProductDetail(item.id)">
                <h3 class="cart-item__name">{{ item.name }}</h3>
                @if (item.brand) {
                  <p class="cart-item__brand">{{ item.brand }}</p>
                }

<!--                 @if (item.note) {
                  <p class="cart-item__note">
                    <span class="cart-item__note-label">Nota:</span>
                    {{ item.note }}
                  </p>
                } -->

                @if (item.product.stock <= 5 && item.product.stock > 0) {
                  <p class="cart-item__stock-warning">
                    ‚ö†Ô∏è Solo quedan {{ item.product.stock }} unidades
                  </p>
                }
              </div>

              <div class="cart-item__controls">
                <div class="cart-item__bottom-row">
                  <div class="cart-item__price-mobile">
                    @if (hasDiscount(item)) {
                      <span class="cart-item__original-price">
                        ${{ formatPrice(item.product.originalPrice) }}
                      </span>
                      <span class="cart-item__discount-badge">
                        -{{ getDiscountPercentage(item) }}%
                      </span>
                    }
                    <span class="cart-item__price">
                      ${{ formatPrice(item.product.finalPrice) }}
                    </span>
                  </div>

                  <div class="cart-item__quantity">
                    <button
                      type="button"
                      class="cart-item__qty-btn"
                      [class.cart-item__qty-btn--loading]="isProcessingItem(item.product.id)"
                      (click)="decreaseQuantity(item)"
                      [disabled]="!canDecrease(item) || !isAvailable(item)"
                      [attr.aria-label]="'Disminuir cantidad de ' + item.product.name">
                      @if (isProcessingItem(item.product.id)) {
                        <span class="cart-item__btn-spinner"></span>
                      } @else {
                        -
                      }
                    </button>

                    <div class="cart-item__qty-display-wrapper">
                      <span class="cart-item__qty-display">
                        {{ item.quantity }}
                      </span>
                      @if (isProcessingItem(item.product.id)) {
                        <div class="cart-item__qty-updating">
                          <span class="cart-item__qty-spinner"></span>
                          <span class="cart-item__qty-updating-text">Actualizando...</span>
                        </div>
                      }
                    </div>

                    <button
                      type="button"
                      class="cart-item__qty-btn"
                      [class.cart-item__qty-btn--loading]="isProcessingItem(item.product.id)"
                      (click)="increaseQuantity(item)"
                      [disabled]="!canIncrease(item)"
                      [attr.aria-label]="'Aumentar cantidad de ' + item.product.name">
                      @if (isProcessingItem(item.product.id)) {
                        <span class="cart-item__btn-spinner"></span>
                      } @else {
                        +
                      }
                    </button>
                  </div>

                  <div class="cart-item__subtotal-wrapper">
                    <span class="cart-item__subtotal-label">Subtotal</span>
                    <span class="cart-item__subtotal">
                      ${{ formatPrice(item.subtotal) }}
                    </span>
                    @if (item.totalDiscount > 0) {
                      <span class="cart-item__discount-amount">
                        Ahorro: ${{ formatPrice(item.totalDiscount) }}
                      </span>
                    }
                  </div>
                </div>
              </div>
            </div>

            <button
              type="button"
              class="cart-item__remove"
              (click)="removeItem(item)"
              [attr.aria-label]="'Eliminar ' + item.product.name">
              √ó
            </button>
          </article>
        }
      </div>

      <!-- Resumen del carrito -->
      <aside class="cart__summary">
        <div class="cart-summary">
          <h3 class="cart-summary__title">Resumen del pedido</h3>

          <div class="cart-summary__line">
            <span class="cart-summary__label">Subtotal ({{ totalItems() }} productos):</span>
            <span class="cart-summary__value">${{ formatPrice(subtotal()) }}</span>
          </div>

          @if (totalDiscount() > 0) {
            <div class="cart-summary__line cart-summary__line--discount">
              <span class="cart-summary__label">Descuentos:</span>
              <span class="cart-summary__value cart-summary__value--discount">
                -${{ formatPrice(totalDiscount()) }}
              </span>
            </div>
          }

          <div class="cart-summary__line">
            <span class="cart-summary__label">Subtotal con descuentos:</span>
            <span class="cart-summary__value">${{ formatPrice(totalAmount()) }}</span>
          </div>

          <div class="cart-summary__line">
            <span class="cart-summary__label">IVA (21%):</span>
            <span class="cart-summary__value">${{ formatPrice(estimatedTax()) }}</span>
          </div>

          @if (estimatedShipping() > 0) {
            <div class="cart-summary__line">
              <span class="cart-summary__label">Env√≠o estimado:</span>
              <span class="cart-summary__value">${{ formatPrice(estimatedShipping()) }}</span>
            </div>
          }

          <hr class="cart-summary__divider">

          <div class="cart-summary__line cart-summary__line--total">
            <span class="cart-summary__label">Total estimado:</span>
            <span class="cart-summary__value cart-summary__value--total">
              ${{ formatPrice(estimatedTotal()) }}
            </span>
          </div>

          <div class="cart-summary__actions">
            <button
              type="button"
              class="cart__btn cart__btn--primary cart__btn--full-width"
              (click)="proceedToCheckout()"
              [disabled]="isEmpty()">
              <span class="cart__btn-text">Finalizar compra</span>
              <span class="cart__btn-icon">‚Üí</span>
            </button>

            <button
              type="button"
              class="cart__btn cart__btn--ghost cart__btn--full-width"
              (click)="continueShopping()">
              ‚Üê Seguir comprando
            </button>
          </div>
        </div>
      </aside>
    </div>

    <!-- Paginador -->

      <div class="cart__pagination">
        <app-paginator
          [meta]="meta()!"
          [entityName]="'productos'"
          [showPageSizeSelector]="true"
          [pageSizeOptions]="[10, 20, 50]"
          [maxVisiblePages]="5"
          (pageChange)="onPageChange($event)"
        />
      </div>

    <div class="cart__footer">
      <button
        type="button"
        class="cart__clear-btn"
        (click)="clearCart()"
        [disabled]="isEmpty()">
        Vaciar carrito
      </button>
    </div>
  }
</div>
